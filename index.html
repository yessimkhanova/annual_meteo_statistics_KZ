<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Temperature and Precipitation for KZ Meteorological Stations</title>
    
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
      body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            transition: width 0.3s ease;
        }

        #image-display {
            width: 0;
            height: 100%;
            overflow-y: auto;
            background-color: #f4f4f4;
            padding: 0;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: width 0.3s ease;
            visibility: hidden;
        }

        #image-display.visible {
            width: 30%;
            padding: 50px;
            visibility: visible;
        }

        #image-display img {
            width: 100%;
            height: auto;
            margin-bottom: 20px;
        }

        #image-display h3 {
            margin-top: 0;
        }

        .info-box {
            position: absolute;
            top: 20px;
            left: 10%;
            transform: translateX(-50%);
            max-width: 250px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 10px 0;
        }

        .description {
            font-size: 12px;
            line-height: 1.6;
        }

        .description a {
            color: blue;
            text-decoration: none;
        }

        .modal {
            display: none; 
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;         
        }
        
        .modal img {
            display: block;
            max-width: none;         
            max-height: none;        
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="info-box">
        <p class="title">Annual Statistics</p>
        <p class="description">
            This webpage is designed to showcase the locations of meteorological stations in Kazakhstan and the
            <strong>annual temperature and precipitation data</strong> for each station during the 1961–2014 period.<br><br>

            <strong style="color: red;">Click on a marker to see graphs.</strong><br><br>

            This project is part of doctoral research
            "Mapping the tendencies of climate change and its effects on the Köppen–Geiger classification – Case study on Kazakhstan"
            conducted by Kalamkas Yessimkhanova, under the supervision of Dr. Matyas Gede at Eötvös Loránd University, Budapest.<br><br>

            The data presented here were utilized for climate analysis and the production of Köppen climate maps for the region of Kazakhstan.
            Resources can be found on the GitHub platform:
            <a href="https://github.com/yessimkhanova?tab=repositories" target="_blank">GitHub</a><br><br>

            Meteorological stations data provided by the National Hydrometeorological Service of Kazakhstan.
            <a href="https://www.kazhydromet.kz/" target="_blank">https://www.kazhydromet.kz/</a>.
            Date accessed: [25.07.2023]
        </p>
    </div>

    <div id="container">
        <div id="map"></div>

        <div id="image-display">
            <h3>Station Data</h3>
            <p>Click on a marker to view images here</p>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modalImage" src="" alt="Large view of the trend">
        </div>
    </div>

    <script>
         var map = L.map('map').setView([48.0196, 66.9237], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var defaultIcon = L.icon({
            iconUrl: 'blue_marker.png',
            iconSize: [29, 33]
        });

        var highlightedIcon = L.icon({
            iconUrl: 'green_marker.png',
            iconSize: [30, 50]
        });

        var currentHighlightedMarker = null; 
        var isSidebarVisible = false;

        function loadStations(csvUrl) {
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    var stations = results.data;
                    addMarkersToMap(stations);
                }
            });
        }

        function addMarkersToMap(stations) {
            stations.forEach(function(station) {
                var stationName = (station.station_name || '').trim();
                var fileName    = stationName.replace(/_/g, '');
                var displayName = stationName.replace(/_/g, ' ');
                var tempImage   = `images/${fileName}_annual_Tmean.png`;
                var precipImage = `images/${fileName}_annual_precip.png`;
                var latitude  = parseFloat(station.latitude);
                var longitude = parseFloat(station.longitude);

                console.log("Temperature Image Path:", tempImage);
                console.log("Precipitation Image Path:", precipImage);

                var marker = L.marker([latitude, longitude], { icon: defaultIcon })
                    .addTo(map)
                    .on('click', function() {
                        var imageDisplay = document.getElementById('image-display');

                        if (!isSidebarVisible) {
                            imageDisplay.classList.add('visible');
                            document.getElementById('map').style.width = '70%';
                            map.invalidateSize();
                            map.panBy([100, 0], { animate: true });
                            isSidebarVisible = true;
                        }

                        if (currentHighlightedMarker) {
                            currentHighlightedMarker.setIcon(defaultIcon);
                        }
                        marker.setIcon(highlightedIcon);
                        currentHighlightedMarker = marker;

                        imageDisplay.innerHTML = `
                            <h3><strong>Station Name:</strong> ${displayName}</h3>
                            <img src="${tempImage}" id="tempImage" alt="Annual Temperature Trend"
                                 onerror="this.style.display='none'">
                            <img src="${precipImage}" id="precipImage" alt="Annual Precipitation Trend"
                                 onerror="this.style.display='none'">
                            <p><a href="#" id="viewTrend">See all stations temperature</a></p>
                        `;

                        document.getElementById('viewTrend').onclick = function(e) {
                            e.preventDefault();
                            openModal('images/annual_mean_temperatures_for_all_stations.jpg');
                        };

                        var tempImgEl = document.getElementById('tempImage');
                        var precImgEl = document.getElementById('precipImage');

                        if (tempImgEl) {
                            tempImgEl.onclick = function() {
                                openModal(tempImage);
                            };
                        }

                        if (precImgEl) {
                            precImgEl.onclick = function() {
                                openModal(precipImage);
                            };
                        }
                    });
            });
        }

        var modal      = document.getElementById("imageModal");
        var modalImage = document.getElementById("modalImage");
        var closeModal = document.getElementsByClassName("close")[0];

        function openModal(imageSrc) {
            modalImage.src = imageSrc;
            modal.style.display = "flex";
        }

        closeModal.onclick = function() {
            modal.style.display = "none";
        };

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };

        loadStations('data/kz_ms.csv');
    </script>
</body>
</html>
